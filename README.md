# Panatrans::KmlExtractor

Kml-extractor is a gem specifically developed to extract the data of from a KML export of the stops and routes generated by the Panamanian transport company MiBus http://mibus.com.pa.

This gem is a proxy to generate a GTFS feed.

It's has been thought just to solve a particular problem and, although it has many things hardcoded for this particular case, it should not be very difficult for a ruby on rails developer to extend it or accommodate the code to another case.

## Expected format of the KML file.

You have a few examples of the KML files on `test/fixtures/` and the export of http://www.mibus.com.pa/rutas/ and https://www.google.com/maps/d/viewer?mid=1qrNCXDiwFL-yWeFNwOw3U2l0v1I


The gem just processes a KML file and outputs a GTFS feed. The KML should have two folders:

    * Folder of stops (name: `Rutas_por_parada` ): A bunch of single points coordinates
    * Folder of routes/trips (name: `RUTAS_METROBUS_2016`): A set of polylines.

## Installation

The best way is to clone this repository

```
    $ git clone https://github.com/merlos/panatrans-kml_extractor
    cd panatrans-kml-extractor
    bundle install
```

## Usage

It includes a simple command line file that does the magic:

```
    cd panatrans-kml_extractor                 # enter the project
    mkdir output-dir                           # we create a directory for the output
    cd output-dir                              # enter the directory
    ../bin/kmlex <path to kml_file>                   # Output files will be saved on current working directory.

```
The output is a complete GTFS feed that includes the following files: agency.txt, calendar.txt, routes.txt, shapes.txt, stop_times.txt, stops.txt and trips.txt,

## Using an alternate stops.txt as source.

You may want to clean the stops before generating the `stop_times.txt` file. In
order to do that, you can use  `bin/stop_times`

```
Usage:
  stop_times <path_to_file.kml> <path_to_stops_file.txt>
```
It generates a `stop_times.txt`file that uses the routes of the KML (first argument)
and the stops of the  txt file provided as second argument.

# The code
`lib/panatrans/kml_extractor.rb` contains all the code. The KMLFile class is the one you should call to generate the output.

Basically, the procedure is to read the KML file, searching for the two folders. To read the file, as it is an XML, nokogiri is used When the stops folder is found, extracts the stop using nokogiri,

## Tests

You can learn how to use the gem by reading the tests.
To run the test, just run the typical:

```
    rake tests
```

## TODO list

 * Add some cleaners. The source of MiBus KML file has orthographic mistakes. Also
 some stations include the bay number. It is hard for the simple algorithm to
 know which bay corresponds to the route/trip.

 * It should be separates the code in several files, one for each class.

## License

The gem is available as open source under the terms of the [MIT License](http://opensource.org/licenses/MIT).


## Related projects

This project belongs to an open source / open data initiative that tries to give more visibility to the data of the public transport system of Panama.

  * [Panatrans dataset](https://github.com/merlos/panatrans-dataset)

  * [Panatrans API](https://github.com/merlos/panatrans-api)

  * [Panatrans Web client](https://github.com/merlos/panatrans-web)

  * [GTFS model for ruby on rails](https://github.com/merlos/gtfs-api)
